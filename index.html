<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Entra API Example</title>
    <script>
        const config = {
            clientId: "YOUR_CLIENT_ID", // Replace with your Azure App's Client ID
            tenantId: "YOUR_TENANT_ID", // Replace with your Azure Tenant ID
            redirectUri: "file:///C:/prodzekty/MyToDoListApp/indexTest.html", // Update with your redirect URI
            apiUrl: "https://localhost:7186/weatherforecast", // Replace with your API endpoint
        };

        const generateCodeVerifier = () => {
            const array = new Uint32Array(32);
            window.crypto.getRandomValues(array);
            return btoa(String.fromCharCode(...new Uint8Array(array)))
                .replace(/\+/g, "-")
                .replace(/\//g, "_")
                .replace(/=+$/, "");
        };

        const generateCodeChallenge = async (verifier) => {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const digest = await window.crypto.subtle.digest("SHA-256", data);
            return btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/\+/g, "-")
                .replace(/\//g, "_")
                .replace(/=+$/, "");
        };

        const login = async () => {
            const codeVerifier = generateCodeVerifier();
            sessionStorage.setItem("code_verifier", codeVerifier);

            const codeChallenge = await generateCodeChallenge(codeVerifier);

            const authUrl = `https://login.microsoftonline.com/${config.tenantId}/oauth2/v2.0/authorize?` +
                `client_id=${config.clientId}&response_type=code&redirect_uri=${encodeURIComponent(config.redirectUri)}` +
                `&response_mode=query&scope=api://${config.clientId}/.default&code_challenge=${codeChallenge}&code_challenge_method=S256`;

            window.location.href = authUrl;
        };

        const fetchAccessToken = async (authCode) => {
            const codeVerifier = sessionStorage.getItem("code_verifier");

            const tokenUrl = `https://login.microsoftonline.com/${config.tenantId}/oauth2/v2.0/token`;
            const body = new URLSearchParams({
                client_id: config.clientId,
                grant_type: "authorization_code",
                code: authCode,
                redirect_uri: config.redirectUri,
                code_verifier: codeVerifier,
            });

            const response = await fetch(tokenUrl, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body,
            });

            const data = await response.json();
            sessionStorage.setItem("access_token", data.access_token);
        };

        const callApi = async () => {
            const token = sessionStorage.getItem("access_token");

            if (!token) {
                alert("You need to log in first!");
                return;
            }

            const response = await fetch(config.apiUrl, {
                headers: {
                    Authorization: `Bearer ${token}`,
                },
            });

            const data = await response.json();
            document.getElementById("output").textContent = JSON.stringify(data, null, 2);
        };

        const handleRedirect = async () => {
            const params = new URLSearchParams(window.location.search);
            const code = params.get("code");

            if (code) {
                await fetchAccessToken(code);
                window.history.replaceState({}, document.title, config.redirectUri);
            }
        };

        document.addEventListener("DOMContentLoaded", handleRedirect);
    </script>
</head>
<body>
    <h1>Azure Entra API Example</h1>
    <button onclick="login()">Login</button>
    <button onclick="callApi()">Call API</button>
    <pre id="output"></pre>
</body>
</html>
